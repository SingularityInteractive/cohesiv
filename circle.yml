machine:
  services:
    - docker
  environment:
    # GOROOT is not set by default
    GOROOT: ""
    GOPATH: "$HOME/.go_project"
    PROJECT_PARENT_PATH: "$GOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME"
    PROJECT_PATH: "$PROJECT_PARENT_PATH/$CIRCLE_PROJECT_REPONAME"
    GO15VENDOREXPERIMENT: 1

dependencies:
  pre:
    - go get -u github.com/golang/dep/cmd/dep
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl
    - wget https://github.com/kubernetes/kops/releases/download/1.6.1/kops-linux-amd64
    - chmod +x kops-linux-amd64
    - sudo mv kops-linux-amd64 /usr/local/bin/kops
  override:
    - mkdir -p "$PROJECT_PARENT_PATH"
    - ln -sf "$HOME/$CIRCLE_PROJECT_REPONAME/" "$PROJECT_PATH"
    - cd "$PROJECT_PATH" && dep ensure
  post:
    - kops version
    - go version
    - cd "$PROJECT_PATH" && dep status

test:
  override:
    - cd "$PROJECT_PATH" && go vet $(go list ./... | grep -v /vendor/)
  post:
    - echo "noop"

deployment:
  development:
    branch: development
    commands:
      - make docker-images
      - make docker-push-ecr
      - kops get cluster --name=development.cohesiv.io
      - kops export kubecfg --name=development.cohesiv.io --state=s3://clusters.cohesiv.io
      - sed -i "s/:latest/:$CIRCLE_SHA1/g" misc/development/deployment.yaml
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
      - kubectl apply -f misc/kube/
      - kubectl apply -f misc/development
  staging:
    branch: staging
    commands:
      - make docker-images
      - make docker-push-ecr
      - kops get cluster --name=staging.cohesiv.io
      - kops export kubecfg --name=staging.cohesiv.io --state=s3://clusters.cohesiv.io
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
      - kubectl apply -f misc/kube/
      - kubectl apply -f misc/staging
  # production:
  #   branch: master
  #   commands:
  #     - sudo /opt/google-cloud-sdk/bin/gcloud container clusters get-credentials production --zone ${CLOUDSDK_COMPUTE_ZONE}
  #     - sed -i "s/:latest/:$CIRCLE_SHA1/g" misc/production/deployment.yaml
  #     - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
  #     - sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
  #     - kubectl apply -f misc/kube/
  #     - kubectl apply -f misc/production