machine:
  services:
    - docker
  environment:
    GOROOT: ""
    GOPATH: "${HOME}/.go_project"
    PATH: "${GOPATH}/bin:${PATH}"
    BUILD_PATH: "${GOPATH}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

dependencies:
  pre:
    - go get -u github.com/golang/dep/cmd/dep
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl
    - wget https://github.com/kubernetes/kops/releases/download/1.6.1/kops-linux-amd64
    - chmod +x kops-linux-amd64
    - sudo mv kops-linux-amd64 /usr/local/bin/kops
  override:
    - mkdir -p ~/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}
    - ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} ${BUILD_PATH}
    - cd $BUILD_PATH && dep ensure
  post:
    - kops version
    - go version

compile:
  override:
    - cd $BUILD_PATH && make docker-images
  post:
    - docker images

test:
  override:
    - cd $BUILD_PATH && go vet $(go list ./... | grep -v /vendor/)

deployment:
  production:
    branch: master
    commands:
      - eval $(aws ecr get-login --region ${AWS_DEFAULT_REGION})
      - make docker-push-ecr
      - kops get cluster --name=cohesiv.io
      - kops export kubecfg --name=cohesiv.io --state=${KOPS_STATE_STORE}
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
      - make authorize-circle-ip
      - kubectl apply -f kube/nginx
      - kubectl apply -f kube/lego
      - kubectl apply -f kube/production
      - make deauthorize-circle-ip
  staging:
    branch: stage
    commands:
      - eval $(aws ecr get-login --region ${AWS_DEFAULT_REGION})
      - make docker-push-ecr
      - kops get cluster --name=stage.cohesiv.io
      - kops export kubecfg --name=stage.cohesiv.io --state=${KOPS_STATE_STORE}
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.config
      - make authorize-circle-ip
      - kubectl apply -f kube/nginx
      - kubectl apply -f kube/lego
      - kubectl apply -f kube/stage
      - make deauthorize-circle-ip